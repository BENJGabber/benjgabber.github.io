<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forum ADEPEM - Mon Portfolio</title>
    <link rel="stylesheet" href="../style.css" />
</head>

<body>
    <!-- Navigation -->
    <nav>
        <div class="nav-container">
            <div class="logo"><a href="../index.html">Mon Portfolio</a></div>
            <ul class="nav-links" id="navLinks">
                <li><a href="../index.html">Accueil</a></li>
                <li><a href="../index.html#apropos">À propos</a></li>
                <li><a href="../formation/formation.html">Parcours et Experiences</a></li>
                <li><a href="#">Forum</a></li>
                <li><a href="#contact">Contact</a></li>
                <button class="theme-toggle" id="themeToggle" aria-label="Changer de thème">
                    <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
            </ul>
            <div class="menu-toggle" id="menuToggle">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
        </div>
    </nav>

    <!-- Side Menu -->
    <div class="side-menu" id="sideMenu">
        <ul class="side-nav-links">
            <li><a href="../index.html">Accueil</a></li>
            <li><a href="../index.html#apropos">À propos</a></li>
            <li><a href="../formation/formation.html">Parcours et Experiences</a></li>
            <li><a href="#">Forum</a></li>
            <li><a href="#contact">Contact</a></li>
        </ul>
    </div>

    <!-- Forum Section -->
    <section id="forum" class="forum-section">
        <div class="container">
            <h1 class="section-title">Forum ADEPEM</h1>
            <p class="forum-subtitle">Dernières discussions de la communauté en temps réel</p>

            <!-- Controls -->
            <div class="forum-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="🔍 Rechercher une discussion...">
                </div>
                <div class="forum-buttons">
                    <button class="refresh-btn" id="refreshBtn">
                        <span class="refresh-icon">🔄</span> Actualiser
                    </button>
                    <a href="https://forum.adepem.com" target="_blank" rel="noopener noreferrer" class="visit-forum-btn">
                        Visiter le forum <span class="external-icon">↗</span>
                    </a>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Chargement des discussions...</p>
            </div>

            <!-- Error State -->
            <div class="forum-error" id="errorMessage" style="display: none;">
                <p id="errorText"></p>
                <button class="retry-btn" id="retryBtn">Réessayer</button>
            </div>

            <!-- Articles Grid -->
            <div class="forum-grid" id="forumGrid"></div>

            <!-- No Results -->
            <div class="no-results" id="noResults" style="display: none;">
                <div class="no-results-icon">💬</div>
                <h3>Aucune discussion trouvée</h3>
                <p>Essayez une autre recherche ou actualisez la page</p>
            </div>
        </div>
    </section>

    <script src="../script.js"></script>
    <script>
        // Configuration du forum ADEPEM
        const FORUM_URL = 'https://forum.adepem.com';
        
        // Liste de proxies CORS (avec fallback)
        const CORS_PROXIES = [
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://api.allorigins.win/raw?url='
        ];
        
        let currentProxyIndex = 0;
        
        // State
        let allTopics = [];
        let filteredTopics = [];

        // Elements
        const loading = document.getElementById('loading');
        const forumGrid = document.getElementById('forumGrid');
        const noResults = document.getElementById('noResults');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const searchInput = document.getElementById('searchInput');
        const refreshBtn = document.getElementById('refreshBtn');
        const retryBtn = document.getElementById('retryBtn');

        // Fetch topics from ADEPEM forum
        async function fetchForumTopics() {
            try {
                loading.style.display = 'block';
                forumGrid.style.display = 'none';
                noResults.style.display = 'none';
                errorMessage.style.display = 'none';

                // Construire l'URL avec le proxy actuel
                const proxyUrl = CORS_PROXIES[currentProxyIndex] + encodeURIComponent(`${FORUM_URL}/latest.json`);
                
                // Timeout de 10 secondes
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch(proxyUrl, {
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }

                const data = await response.json();
                
                // Limiter à 12 discussions
                allTopics = data.topic_list.topics.slice(0, 12);
                filteredTopics = [...allTopics];
                displayTopics();
                
                // Réinitialiser l'index du proxy en cas de succès
                currentProxyIndex = 0;
            } catch (error) {
                console.error('Erreur détaillée:', error);
                
                // Essayer le proxy suivant si disponible
                if (currentProxyIndex < CORS_PROXIES.length - 1) {
                    currentProxyIndex++;
                    console.log(`Tentative avec un autre proxy (${currentProxyIndex + 1}/${CORS_PROXIES.length})...`);
                    return fetchForumTopics(); // Réessayer avec le proxy suivant
                }
                
                // Si tous les proxies ont échoué
                loading.style.display = 'none';
                errorMessage.style.display = 'block';
                currentProxyIndex = 0; // Réinitialiser pour la prochaine tentative
                
                // Message d'erreur
                if (error.name === 'AbortError') {
                    errorText.textContent = 'Le serveur met trop de temps à répondre. Réessayez dans quelques instants.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorText.textContent = 'Impossible de se connecter au forum. Vérifiez votre connexion internet.';
                } else {
                    errorText.textContent = error.message || 'Impossible de charger les discussions du forum';
                }
            }
        }

        // Display topics
        function displayTopics() {
            loading.style.display = 'none';

            if (filteredTopics.length === 0) {
                forumGrid.style.display = 'none';
                noResults.style.display = 'block';
                return;
            }

            forumGrid.style.display = 'grid';
            noResults.style.display = 'none';

            forumGrid.innerHTML = filteredTopics.map(topic => {
                const lastActivityDate = new Date(topic.last_posted_at || topic.created_at);
                const formattedDate = formatDate(lastActivityDate);
                
                return `
                    <a href="${FORUM_URL}/t/${topic.slug}/${topic.id}" target="_blank" rel="noopener noreferrer" class="forum-card">
                        <div class="forum-card-header">
                            <div class="forum-card-badges">
                                ${topic.pinned ? '<span class="badge badge-pinned">📌 Épinglé</span>' : ''}
                                ${topic.closed ? '<span class="badge badge-closed">🔒 Fermé</span>' : ''}
                            </div>
                            <span class="external-link-icon">↗</span>
                        </div>
                        
                        <h3 class="forum-card-title">${escapeHtml(topic.title)}</h3>
                        
                        <div class="forum-card-stats">
                            <span class="stat">
                                <span class="stat-icon">💬</span>
                                <span class="stat-value">${topic.posts_count - 1}</span>
                            </span>
                            <span class="stat">
                                <span class="stat-icon">👤</span>
                                <span class="stat-value">${topic.posters?.length || 0}</span>
                            </span>
                            <span class="stat">
                                <span class="stat-icon">🕒</span>
                                <span class="stat-value">${formattedDate}</span>
                            </span>
                        </div>
                        
                        ${topic.category_id ? `
                            <div class="forum-card-category">
                                <span class="category-badge" style="background-color: #${topic.category_color || '6366f1'}20; border-color: #${topic.category_color || '6366f1'}50; color: #${topic.category_color || 'a5b4fc'}">
                                    ${escapeHtml(topic.category_name || 'Général')}
                                </span>
                            </div>
                        ` : ''}
                    </a>
                `;
            }).join('');
        }

        // Format date
        function formatDate(date) {
            const now = new Date();
            const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
            
            if (diffInHours < 1) return 'Il y a moins d\'1h';
            if (diffInHours < 24) return `Il y a ${diffInHours}h`;
            if (diffInHours < 48) return 'Hier';
            const diffInDays = Math.floor(diffInHours / 24);
            if (diffInDays < 7) return `Il y a ${diffInDays}j`;
            return date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Search functionality
        searchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            
            filteredTopics = allTopics.filter(topic => 
                topic.title.toLowerCase().includes(searchTerm)
            );
            
            displayTopics();
        });

        // Refresh button
        refreshBtn.addEventListener('click', () => {
            searchInput.value = '';
            fetchForumTopics();
        });

        // Retry button
        retryBtn.addEventListener('click', fetchForumTopics);

        // Initialize
        fetchForumTopics();

        // Auto-refresh every 5 minutes
        setInterval(fetchForumTopics, 5 * 60 * 1000);
    </script>
</body>

</html>
